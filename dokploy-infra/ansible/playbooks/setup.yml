---
- name: Setup Docker + Dokploy Infrastructure (Native Installation)
  hosts: servers
  become: yes
  gather_facts: yes
  vars_files:
    - ../vars/main.yml

  pre_tasks:
    - name: Display banner
      debug:
        msg:
          - "================================================"
          - "üöÄ Dokploy Infrastructure Setup (Native)"
          - "================================================"
          - "Target: {{ inventory_hostname }}"
          - "User: {{ ansible_user_id }}"
          - "Mode: Dokploy runs natively (not in container)"
          - "================================================"

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

  roles:
    - role: system_detection
      tags: ['system', 'detection']
    
    - role: docker
      tags: ['docker', 'infrastructure']
    
    - role: node
      tags: ['node', 'runtime']
    
    - role: firewall
      tags: ['firewall', 'security']
      when: firewall_enabled | default(true)
    
    - role: dokploy
      tags: ['dokploy', 'application']
    
    - role: validation
      tags: ['validation', 'verify']

  post_tasks:
    - name: Display completion message
      debug:
        msg:
          - "================================================"
          - "‚úì SETUP COMPLETED SUCCESSFULLY"
          - "================================================"
          - "Dokploy is ready at: http://{{ ansible_default_ipv4.address }}:{{ dokploy_port }}"
          - ""
          - "Installation type: NATIVE (not containerized)"
          - "Installation path: {{ dokploy_install_dir }}"
          - ""
          - "Next steps:"
          - "1. Access Dokploy web interface"
          - "2. Complete initial configuration"
          - "3. Deploy your applications"
          - ""
          - "Service management:"
          - "  systemctl status dokploy    # Check status"
          - "  journalctl -u dokploy -f    # View logs"
          - "  systemctl restart dokploy   # Restart service"
          - ""
          - "Docker (for Dokploy to manage):"
          - "  docker ps                   # List containers"
          - "  docker network ls           # List networks"
          - "================================================"

    - name: Remind about re-login if needed
      debug:
        msg: "‚ö†Ô∏è  If 'docker ps' doesn't work without sudo, logout and login again to refresh group membership"
      when: ansible_user_id != "root"
