---
- name: Setup Docker + Dokploy (Native Installation)
  hosts: servers
  become: yes
  gather_facts: yes
  vars_files:
    - ../vars/main.yml

  pre_tasks:
    - name: Show info
      debug:
        msg:
          - "=========================================="
          - "  Dokploy Infrastructure Setup (Native)"
          - "=========================================="
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
          - "Arch: {{ ansible_facts['architecture'] }}"
          - "=========================================="

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

  roles:
    - role: docker
      tags: ['docker']

    - role: node
      tags: ['node']

    - role: dokploy
      tags: ['dokploy']

  post_tasks:
    - name: Done
      debug:
        msg:
          - "=========================================="
          - "  INSTALLATION COMPLETE"
          - "=========================================="
          - ""
          - "Dokploy: http://localhost:{{ dokploy_port }}"
          - "Path:    {{ dokploy_install_dir }}"
          - ""
          - "Commands:"
          - "  systemctl status dokploy"
          - "  journalctl -u dokploy -f"
          - "  sudo systemctl restart dokploy"
          - ""
          - "If 'docker ps' fails without sudo:"
          - "  exit WSL, run: wsl --shutdown"
          - "  reopen WSL and try again"
          - "=========================================="
