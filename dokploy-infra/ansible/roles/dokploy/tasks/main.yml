---
# ============================================================
# Dokploy Native Installation - Compatible with Ansible 2.14+
# ============================================================

- name: Create dokploy group
  group:
    name: "{{ dokploy_group }}"
    system: yes

- name: Create dokploy user
  user:
    name: "{{ dokploy_user }}"
    system: yes
    shell: /bin/bash
    home: "/home/{{ dokploy_user }}"
    group: "{{ dokploy_group }}"
    groups: docker
    append: yes
    create_home: yes

- name: Check if install dir exists
  stat:
    path: "{{ dokploy_install_dir }}"
  register: install_dir

- name: Check if already cloned
  stat:
    path: "{{ dokploy_install_dir }}/.git"
  register: dokploy_git
  when: install_dir.stat.exists

- name: Set clone needed fact
  set_fact:
    needs_clone: "{{ not install_dir.stat.exists or dokploy_git is skipped or not dokploy_git.stat.exists }}"

- name: Remove incomplete install dir (exists but no .git)
  file:
    path: "{{ dokploy_install_dir }}"
    state: absent
  when: needs_clone | bool and install_dir.stat.exists

- name: Clone Dokploy
  command: >
    git clone --branch {{ dokploy_version }} --depth 1
    {{ dokploy_repo }} {{ dokploy_install_dir }}
  when: needs_clone | bool
  register: dokploy_cloned

- name: Set ownership on install dir
  file:
    path: "{{ dokploy_install_dir }}"
    owner: "{{ dokploy_user }}"
    group: "{{ dokploy_group }}"
    recurse: yes
  when: dokploy_cloned is changed

- name: Create database directory
  file:
    path: "{{ dokploy_database_dir }}"
    state: directory
    owner: "{{ dokploy_user }}"
    group: "{{ dokploy_group }}"
    mode: '0755'

- name: Update Dokploy
  shell: cd {{ dokploy_install_dir }} && git fetch --tags && git checkout {{ dokploy_version }}
  become_user: "{{ dokploy_user }}"
  when: not needs_clone | bool
  register: dokploy_updated
  changed_when: dokploy_updated.rc == 0
  failed_when: false

- name: Check if node_modules exists
  stat:
    path: "{{ dokploy_install_dir }}/node_modules"
  register: node_modules

- name: Find pnpm path
  command: which pnpm
  register: pnpm_path
  changed_when: false

- name: Install dependencies
  command: "{{ pnpm_path.stdout }} install"
  args:
    chdir: "{{ dokploy_install_dir }}"
  become_user: "{{ dokploy_user }}"
  when: >
    not node_modules.stat.exists
    or (dokploy_cloned is defined and dokploy_cloned.changed)
    or (dokploy_updated is defined and dokploy_updated.changed)

- name: Check if dist exists
  stat:
    path: "{{ dokploy_install_dir }}/dist"
  register: dist_dir

- name: Build application
  command: "{{ pnpm_path.stdout }} run build"
  args:
    chdir: "{{ dokploy_install_dir }}"
  become_user: "{{ dokploy_user }}"
  environment:
    NODE_ENV: production
  when: >
    not dist_dir.stat.exists
    or (dokploy_cloned is defined and dokploy_cloned.changed)
    or (dokploy_updated is defined and dokploy_updated.changed)

- name: Create Docker network for Dokploy
  command: docker network create {{ dokploy_network }}
  register: net_result
  changed_when: net_result.rc == 0
  failed_when: false

- name: Install systemd service
  template:
    src: dokploy.service.j2
    dest: /etc/systemd/system/dokploy.service
    mode: '0644'
  notify: restart dokploy

- name: Reload systemd
  command: systemctl daemon-reload
  changed_when: false

- name: Enable and start Dokploy
  service:
    name: dokploy
    enabled: yes
    state: started

- name: Wait for Dokploy to respond
  uri:
    url: "http://localhost:{{ dokploy_port }}"
    status_code: [200, 302]
    timeout: 5
  register: health
  until: health.status is defined and health.status in [200, 302]
  retries: 30
  delay: 3
  ignore_errors: yes

- name: Status
  debug:
    msg: "{{ 'Dokploy running at http://localhost:' ~ dokploy_port if health is succeeded else 'Dokploy started but not responding yet. Check: journalctl -u dokploy -f' }}"
