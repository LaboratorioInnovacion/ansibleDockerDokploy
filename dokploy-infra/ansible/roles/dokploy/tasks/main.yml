---
# ============================================================
# Dokploy Native Installation - Compatible with Ansible 2.14+
# ============================================================

- name: Create dokploy group
  group:
    name: "{{ dokploy_group }}"
    system: yes

- name: Create dokploy user
  user:
    name: "{{ dokploy_user }}"
    system: yes
    shell: /bin/bash
    home: "{{ dokploy_install_dir }}"
    group: "{{ dokploy_group }}"
    groups: docker
    append: yes
    create_home: no

- name: Create directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ dokploy_user }}"
    group: "{{ dokploy_group }}"
    mode: '0755'
  loop:
    - "{{ dokploy_install_dir }}"
    - "{{ dokploy_database_dir }}"

- name: Check if already cloned
  stat:
    path: "{{ dokploy_install_dir }}/.git"
  register: dokploy_git

- name: Clone Dokploy
  git:
    repo: "{{ dokploy_repo }}"
    dest: "{{ dokploy_install_dir }}"
    version: "{{ dokploy_version }}"
    force: no
  become_user: "{{ dokploy_user }}"
  when: not dokploy_git.stat.exists
  register: dokploy_cloned

- name: Update Dokploy
  git:
    repo: "{{ dokploy_repo }}"
    dest: "{{ dokploy_install_dir }}"
    version: "{{ dokploy_version }}"
    update: yes
  become_user: "{{ dokploy_user }}"
  when: dokploy_git.stat.exists
  register: dokploy_updated

- name: Check if node_modules exists
  stat:
    path: "{{ dokploy_install_dir }}/node_modules"
  register: node_modules

- name: Install dependencies
  command: pnpm install
  args:
    chdir: "{{ dokploy_install_dir }}"
  become_user: "{{ dokploy_user }}"
  when: >
    not node_modules.stat.exists
    or (dokploy_cloned is defined and dokploy_cloned.changed)
    or (dokploy_updated is defined and dokploy_updated.changed)

- name: Check if dist exists
  stat:
    path: "{{ dokploy_install_dir }}/dist"
  register: dist_dir

- name: Build application
  command: pnpm run build
  args:
    chdir: "{{ dokploy_install_dir }}"
  become_user: "{{ dokploy_user }}"
  environment:
    NODE_ENV: production
  when: >
    not dist_dir.stat.exists
    or (dokploy_cloned is defined and dokploy_cloned.changed)
    or (dokploy_updated is defined and dokploy_updated.changed)

- name: Create Docker network for Dokploy
  command: docker network create {{ dokploy_network }}
  register: net_result
  changed_when: net_result.rc == 0
  failed_when: false

- name: Install systemd service
  template:
    src: dokploy.service.j2
    dest: /etc/systemd/system/dokploy.service
    mode: '0644'
  notify: restart dokploy

- name: Reload systemd
  command: systemctl daemon-reload
  changed_when: false

- name: Enable and start Dokploy
  service:
    name: dokploy
    enabled: yes
    state: started

- name: Wait for Dokploy to respond
  uri:
    url: "http://localhost:{{ dokploy_port }}"
    status_code: [200, 302]
    timeout: 5
  register: health
  until: health.status is defined and health.status in [200, 302]
  retries: 30
  delay: 3
  ignore_errors: yes

- name: Status
  debug:
    msg: "{{ 'Dokploy running at http://localhost:' ~ dokploy_port if health is succeeded else 'Dokploy started but not responding yet. Check: journalctl -u dokploy -f' }}"
