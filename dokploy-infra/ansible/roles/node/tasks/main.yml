---
# ============================================================
# Node.js + pnpm Installation - Compatible with Ansible 2.14+
# ============================================================

- name: Check if Node.js is installed
  command: node --version
  register: node_check
  changed_when: false
  failed_when: false

- name: Download NodeSource setup script
  get_url:
    url: "https://deb.nodesource.com/setup_{{ node_version }}.x"
    dest: /tmp/nodesource_setup.sh
    mode: '0755'
  when: node_check.rc != 0

- name: Run NodeSource setup
  command: bash /tmp/nodesource_setup.sh
  when: node_check.rc != 0

- name: Install Node.js
  apt:
    name: nodejs
    state: present
    update_cache: yes
  when: node_check.rc != 0

- name: Clean up setup script
  file:
    path: /tmp/nodesource_setup.sh
    state: absent

- name: Install pnpm globally
  npm:
    name: pnpm
    global: yes
    state: present

- name: Verify installations
  command: "{{ item }}"
  loop:
    - node --version
    - npm --version
    - pnpm --version
  register: versions
  changed_when: false

- name: Show versions
  debug:
    msg:
      - "Node.js: {{ versions.results[0].stdout }}"
      - "npm:     {{ versions.results[1].stdout }}"
      - "pnpm:    {{ versions.results[2].stdout }}"
