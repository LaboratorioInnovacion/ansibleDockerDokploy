---
- name: Check if Node.js is already installed
  command: node --version
  register: node_check
  changed_when: false
  failed_when: false

- name: Display current Node.js version if installed
  debug:
    msg: "Node.js already installed: {{ node_check.stdout }}"
  when: node_check.rc == 0

- name: Download NodeSource setup script
  get_url:
    url: "https://deb.nodesource.com/setup_{{ node_version }}.x"
    dest: /tmp/nodesource_setup.sh
    mode: '0755'
  when: node_check.rc != 0

- name: Run NodeSource setup script
  command: bash /tmp/nodesource_setup.sh
  when: node_check.rc != 0

- name: Install Node.js
  apt:
    name: nodejs
    state: present
    update_cache: yes
  when: node_check.rc != 0

- name: Clean up NodeSource script
  file:
    path: /tmp/nodesource_setup.sh
    state: absent

- name: Verify Node.js installation
  command: node --version
  register: node_version_output
  changed_when: false

- name: Verify npm installation
  command: npm --version
  register: npm_version_output
  changed_when: false

- name: Display Node.js and npm versions
  debug:
    msg:
      - "✓ Node.js: {{ node_version_output.stdout }}"
      - "✓ npm: {{ npm_version_output.stdout }}"

- name: Install pnpm globally
  npm:
    name: pnpm
    global: yes
    state: present

- name: Verify pnpm installation
  command: pnpm --version
  register: pnpm_version_output
  changed_when: false

- name: Display pnpm version
  debug:
    msg: "✓ pnpm: {{ pnpm_version_output.stdout }}"
